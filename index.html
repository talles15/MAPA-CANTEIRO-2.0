function gerarMapa() {
            mostrarPainel('map-panel');
            
            document.getElementById('canteiro-title').textContent = 'Mapa do Canteiro ' + configuracao.canteiro;
            
            // Calcular estat√≠sticas do canteiro
            const tiposUnicos = [...new Set(amostras.map(a => a.tipoTeste).filter(t => t))];
            let tipoTesteDisplay;
            
            if (tiposUnicos.length === 0) {
                tipoTesteDisplay = configuracao.tipoTeste;
            } else if (tiposUnicos.length === 1) {
                tipoTesteDisplay = tiposUnicos[0];
            } else {
                tipoTesteDisplay = tiposUnicos.join(', ') + ' (M√∫ltiplos)';
            }
            
            const dataFormatada = new Date(configuracao.data).toLocaleDateString('pt-BR');
            document.getElementById('canteiro-details').innerHTML = 
                'üìÖ Data: ' + dataFormatada + ' | ' +
                'üß™ Teste: ' + tipoTesteDisplay + ' | ' +
                'üìä Total de Amostras: ' + amostras.length;

            const amostrasEsquerda = amostras.filter(a => a.lado === 'esquerdo').sort((a, b) => a.posicao - b.posicao);
            const amostrasDireita = amostras.filter(a => a.lado === 'direito').sort((a, b) => a.posicao - b.posicao);
            
            const maxPosicoes = Math.max(amostrasEsquerda.length, amostrasDireita.length, 45);

            const tbody = document.getElementById('mapa-tbody');
            tbody.innerHTML = '';

            for (let i = 0; i < maxPosicoes; i++) {
                const row = document.createElement('tr');
                
                // Posi√ß√£o
                const posicaoCell = document.createElement('td');
                posicaoCell.textContent = i + 1;
                posicaoCell.style.fontWeight = 'bold';
                row.appendChild(posicaoCell);

                // Lado Esquerdo
                const esquerdaCell = document.createElement('td');
                esquerdaCell.className = 'sample-cell';
                const amostraEsquerda = amostrasEsquerda.find(a => a.posicao === i + 1);
                
                if (amostraEsquerda) {
                    const codigo = document.createElement('strong');
                    codigo.textContent = amostraEsquerda.codigo;
                    
                    const info = document.createElement('div');
                    info.className = 'sample-info';
                    
                    const tipoTeste = amostraEsquerda.tipoTeste || 'N/A';
                    const origem = amostraEsquerda.tipoRemessa ? ' | ' + amostraEsquerda.tipoRemessa : '';
                    const data = ' | ' + new Date(amostraEsquerda.timestamp).toLocaleDateString('pt-BR');
                    const manual = amostraEsquerda.manual ? ' (Manual)' : '';
                    
                    info.textContent = tipoTeste + origem + data + manual;
                    
                    esquerdaCell.appendChild(codigo);
                    esquerdaCell.appendChild(info);
                    esquerdaCell.style.cursor = 'pointer';
                    
                    esquerdaCell.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        editarOuRemoverAmostra(amostraEsquerda);
                    });
                } else {
                    const vazio = document.createElement('em');
                    vazio.style.color = '#ccc';
                    vazio.textContent = 'Vazio';
                    esquerdaCell.appendChild(vazio);
                    esquerdaCell.className += ' empty';
                    esquerdaCell.style.cursor = 'pointer';
                    
                    esquerdaCell.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        adicionarAmostraNaPosicao('esquerdo', i + 1);
                    });
                }
                row.appendChild(esquerdaCell);

                // Lado Direito
                const direitaCell = document.createElement('td');
                direitaCell.className = 'sample-cell';
                const amostraDireita = amostrasDireita.find(a => a.posicao === i + 1);
                
                if (amostraDireita) {
                    const codigo = document.createElement('strong');
                    codigo.textContent = amostraDireita.codigo;
                    
                    const info = document.createElement('div');
                    info.className = 'sample-info';
                    
                    const tipoTeste = amostraDireita.tipoTeste || 'N/A';
                    const origem = amostraDireita.tipoRemessa ? ' | ' + amostraDireita.tipoRemessa : '';
                    const data = ' | ' + new Date(amostraDireita.timestamp).toLocaleDateString('pt-BR');
                    const manual = amostraDireita.manual ? ' (Manual)' : '';
                    
                    info.textContent = tipoTeste + origem + data + manual;
                    
                    direitaCell.appendChild(codigo);
                    direitaCell.appendChild(info);
                    direitaCell.style.cursor = 'pointer';
                    
                    direitaCell.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        editarOuRemoverAmostra(amostraDireita);
                    });
                } else {
                    const vazio = document.createElement('em');
                    vazio.style.color = '#ccc';
                    vazio.textContent = 'Vazio';
                    direitaCell.appendChild(vazio);
                    direitaCell.className += ' empty';
                    direitaCell.style.cursor = 'pointer';
                    
                    direitaCell.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        adicionarAmostraNaPosicao('direito', i + 1);
                    });
                }
                row.appendChild(direitaCell);

                tbody.appendChild(row);
            }
        }<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeamento de Canteiros</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2E8B57, #228B22);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-menu {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .menu-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .menu-btn {
            padding: 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .menu-btn-primary {
            background: linear-gradient(45deg, #2E8B57, #228B22);
            color: white;
        }
        
        .menu-btn-secondary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .menu-btn-info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .saved-canteiros {
            margin-top: 20px;
        }
        
        .canteiro-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .canteiro-item:hover {
            border-color: #2E8B57;
            box-shadow: 0 2px 8px rgba(46, 139, 87, 0.1);
        }
        
        .canteiro-info-item {
            flex: 1;
        }
        
        .canteiro-actions {
            display: flex;
            gap: 10px;
        }
        
        .setup-panel {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: none;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2E8B57;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }
        
        .lado-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .lado-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .lado-btn.active {
            background: #2E8B57;
            color: white;
            border-color: #2E8B57;
        }
        
        .scanning-panel {
            padding: 30px;
            text-align: center;
            display: none;
        }
        
        .camera-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        #qr-video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        
        .scanning-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #2E8B57;
            border-radius: 10px;
            box-shadow: inset 0 0 0 2px white;
        }
        
        .scan-info {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #2E8B57;
        }
        
        .manual-entry-panel {
            padding: 30px;
            background: #f8f9fa;
            display: none;
        }
        
        .manual-form {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #2E8B57, #228B22);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .map-panel {
            padding: 30px;
            display: none;
        }
        
        .canteiro-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .canteiro-info h3 {
            color: #2E8B57;
            margin-bottom: 10px;
        }
        
        .map-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .map-table th,
        .map-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
        }
        
        .map-table th {
            background: linear-gradient(45deg, #2E8B57, #228B22);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .map-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .map-table tr:hover {
            background: #e8f5e8;
        }
        
        .sample-cell {
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-height: 50px;
        }
        
        .sample-cell:hover {
            background: #d4edda !important;
        }
        
        .sample-cell.editing {
            background: #fff3cd !important;
        }
        
        .sample-cell.empty {
            background: #f8f9fa;
            color: #6c757d;
            font-style: italic;
        }
        
        .sample-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .status-bar {
            background: #2E8B57;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .progress-info {
            margin: 15px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            text-align: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .menu-buttons {
                grid-template-columns: 1fr;
            }
            
            .canteiro-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .canteiro-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Sistema de Mapeamento de Canteiros</h1>
            <p>Controle de plantio de testes com QR Code</p>
        </div>
        
        <!-- Menu Principal -->
        <div id="main-menu" class="main-menu">
            <div class="menu-buttons">
                <button class="menu-btn menu-btn-primary" onclick="novoCanteiro()">
                    <span style="font-size: 2rem;">üÜï</span>
                    <span>Novo Canteiro</span>
                </button>
                
                <button class="menu-btn menu-btn-secondary" onclick="mostrarCanteirosSalvos()">
                    <span style="font-size: 2rem;">üìÇ</span>
                    <span>Canteiros Salvos</span>
                </button>
                
                <button class="menu-btn menu-btn-info" onclick="importarDados()">
                    <span style="font-size: 2rem;">üì•</span>
                    <span>Importar Dados</span>
                </button>
            </div>
            
            <div id="saved-canteiros-list" class="saved-canteiros" style="display: none;">
                <h3>üìã Canteiros Salvos:</h3>
                <div id="canteiros-container"></div>
            </div>
        </div>
        
        <!-- Painel de Configura√ß√£o -->
        <div id="setup-panel" class="setup-panel">
            <div class="form-grid">
                <div class="form-group">
                    <label for="canteiro-num">N√∫mero do Canteiro</label>
                    <input type="text" id="canteiro-num" placeholder="Ex: C001" required>
                </div>
                
                <div class="form-group">
                    <label for="data-plantio">Data do Plantio</label>
                    <input type="date" id="data-plantio" required>
                </div>
                
                <div class="form-group">
                    <label for="tipo-teste">Tipo de Teste</label>
                    <select id="tipo-teste" required>
                        <option value="">Selecione...</option>
                        <option value="GA">GA - Germina√ß√£o</option>
                        <option value="EA48">EA48 - Envelhecimento 48h</option>
                        <option value="EA72">EA72 - Envelhecimento 72h</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Lado do Canteiro para Iniciar</label>
                    <div class="lado-buttons">
                        <button class="lado-btn" data-lado="esquerdo">‚¨ÖÔ∏è Esquerdo</button>
                        <button class="lado-btn active" data-lado="direito">Direito ‚û°Ô∏è</button>
                    </div>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-primary" onclick="iniciarScan()">üì± Leitura QR</button>
                <button class="btn btn-secondary" onclick="mostrarEntradaManual()">‚úèÔ∏è Entrada Manual</button>
                <button class="btn btn-info" onclick="voltarMenu()">üè† Menu</button>
            </div>
        </div>
        
        <!-- Painel de Leitura QR -->
        <div id="scanning-panel" class="scanning-panel">
            <div class="status-bar">
                <span id="scan-status">Preparando c√¢mera...</span>
            </div>
            
            <div class="camera-container">
                <video id="qr-video"></video>
                <div class="scanning-overlay"></div>
            </div>
            
            <div class="progress-info">
                <strong>Amostras Lidas: <span id="sample-count">0</span>/90</strong>
                <br>
                <small>Lado atual: <span id="current-side">Direito</span></small>
            </div>
            
            <div class="scan-info">
                <p><strong>üìã Como usar:</strong></p>
                <p>1. Posicione o QR code dentro do quadrado verde</p>
                <p>2. O c√≥digo ser√° lido automaticamente</p>
                <p>3. A amostra ser√° adicionada na sequ√™ncia</p>
                <p><small>üí° Capacidade: 90 amostras (45 por lado)</small></p>
            </div>
            
            <div class="buttons">
                <button class="btn btn-secondary" onclick="trocarLado()">üîÑ Trocar Lado</button>
                <button class="btn btn-primary" onclick="finalizarScan()">‚úÖ Finalizar</button>
                <button class="btn btn-danger" onclick="pararScan()">‚ùå Parar</button>
            </div>
        </div>
        
        <!-- Painel de Entrada Manual -->
        <div id="manual-entry-panel" class="manual-entry-panel">
            <div class="manual-form">
                <h3 style="text-align: center; margin-bottom: 20px; color: #2E8B57;">üìù Entrada Manual de Amostra</h3>
                
                <div class="form-group">
                    <label for="manual-codigo">C√≥digos das Amostras</label>
                    <input type="text" id="manual-codigo" placeholder="Ex: 10;20;30 ou apenas 10">
                    <small style="color: #6c757d; font-size: 12px;">
                        üí° <strong>M√∫ltiplas amostras:</strong> Separe por ponto e v√≠rgula (;)<br>
                        üìã <strong>Exemplo:</strong> 10;20;30 (criar√° 3 amostras sequenciais)
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="manual-tipo-teste-individual">Tipo de Teste</label>
                    <select id="manual-tipo-teste-individual">
                        <option value="">Selecione...</option>
                        <option value="GA">GA - Germina√ß√£o</option>
                        <option value="EA48">EA48 - Envelhecimento 48h</option>
                        <option value="EA72">EA72 - Envelhecimento 72h</option>
                    </select>
                    <small style="color: #6c757d; font-size: 12px;">
                        üí° <strong>Flexibilidade:</strong> Cada amostra pode ter um tipo de teste diferente
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="manual-tipo-remessa">Origem da Amostra</label>
                    <select id="manual-tipo-remessa">
                        <option value="">Selecione...</option>
                        <option value="Lote">Lote</option>
                        <option value="TSI">TSI</option>
                        <option value="Carregamento">Carregamento</option>
                        <option value="Teste">Teste</option>
                        <option value="Reclama√ß√£o">Reclama√ß√£o</option>
                        <option value="Entrada de Semente">Entrada de Semente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="manual-lado">Lado do Canteiro</label>
                    <select id="manual-lado">
                        <option value="direito">Direito</option>
                        <option value="esquerdo">Esquerdo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="manual-posicao">Posi√ß√£o Inicial</label>
                    <input type="number" id="manual-posicao" min="1" placeholder="Ex: 1">
                    <small style="color: #6c757d; font-size: 12px;">
                        üìç <strong>Posi√ß√£o inicial:</strong> Amostras m√∫ltiplas ser√£o colocadas em sequ√™ncia<br>
                        üìã <strong>Exemplo:</strong> Posi√ß√£o 1 ‚Üí amostras nas posi√ß√µes 1, 2, 3...
                    </small>
                </div>
                
                <div id="preview-area" style="display: none; margin: 15px 0; padding: 10px; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #2E8B57;">
                    <strong>üìã Preview das amostras:</strong>
                    <div id="preview-content"></div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-primary" onclick="adicionarAmostraManual()">‚ûï Adicionar</button>
                    <button class="btn btn-secondary" onclick="previewAmostras()">üëÅÔ∏è Preview</button>
                    <button class="btn btn-secondary" onclick="voltarParaSetup()">‚¨ÖÔ∏è Voltar</button>
                </div>
            </div>
        </div>
        
        <!-- Painel do Mapa -->
        <div id="map-panel" class="map-panel">
            <div class="canteiro-info">
                <h3 id="canteiro-title">Mapa do Canteiro</h3>
                <p id="canteiro-details">Detalhes do plantio</p>
            </div>
            
            <table class="map-table" id="mapa-table">
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>Lado Esquerdo</th>
                        <th>Lado Direito</th>
                    </tr>
                </thead>
                <tbody id="mapa-tbody">
                </tbody>
            </table>
            
            <div class="buttons">
                <button class="btn btn-primary" onclick="continuarAdicionando()">‚ûï Continuar Adicionando</button>
                <button class="btn btn-secondary" onclick="mostrarEntradaManual()">‚úèÔ∏è Entrada Manual</button>
                <button class="btn btn-warning" onclick="limparCanteiro()">üßπ Limpar Canteiro</button>
                <button class="btn btn-info" onclick="exportarMapa()">üìÑ Exportar JSON</button>
                <button class="btn btn-info" onclick="exportarPDF()">üìë Exportar PDF</button>
                <button class="btn btn-secondary" onclick="voltarMenu()">üè† Menu</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h3 id="modal-title">Confirmar A√ß√£o</h3>
            <p id="modal-message">Tem certeza?</p>
            <div class="buttons">
                <button class="btn btn-danger" id="modal-confirm">Confirmar</button>
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Input oculto para importar arquivos -->
    <input type="file" id="import-input" accept=".json" style="display: none;" onchange="processarImportacao(event)">

    <script>
        let scanner = null;
        let amostras = [];
        let ladoAtual = 'direito';
        let configuracao = {};
        let canteiroAtual = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('data-plantio').valueAsDate = new Date();
            carregarCanteirosSalvos();
            
            // Gerenciar sele√ß√£o de lado
            document.querySelectorAll('.lado-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.lado-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    ladoAtual = this.dataset.lado;
                });
            });
        });

        // ===== GERENCIAMENTO DE DADOS =====
        function salvarDados() {
            const dados = {
                configuracao: configuracao,
                amostras: amostras,
                ultimaAtualizacao: new Date().toISOString()
            };
            
            localStorage.setItem(`canteiro_${configuracao.canteiro}`, JSON.stringify(dados));
            carregarCanteirosSalvos();
        }

        function carregarDados(canteiro) {
            const dados = localStorage.getItem(`canteiro_${canteiro}`);
            if (dados) {
                const dadosObj = JSON.parse(dados);
                configuracao = dadosObj.configuracao;
                amostras = dadosObj.amostras || [];
                canteiroAtual = canteiro;
                
                // Preencher formul√°rio
                document.getElementById('canteiro-num').value = configuracao.canteiro;
                document.getElementById('data-plantio').value = configuracao.data;
                document.getElementById('tipo-teste').value = configuracao.tipoTeste;
                
                return true;
            }
            return false;
        }

        function carregarCanteirosSalvos() {
            const container = document.getElementById('canteiros-container');
            container.innerHTML = '';
            
            let canteirosEncontrados = false;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('canteiro_')) {
                    canteirosEncontrados = true;
                    const dados = JSON.parse(localStorage.getItem(key));
                    const canteiro = key.replace('canteiro_', '');
                    
                    const item = document.createElement('div');
                    item.className = 'canteiro-item';
                    item.innerHTML = `
                        <div class="canteiro-info-item">
                            <strong>Canteiro: ${dados.configuracao.canteiro}</strong><br>
                            <small>üìÖ ${new Date(dados.configuracao.data).toLocaleDateString('pt-BR')} | 
                            üß™ ${dados.configuracao.tipoTeste} | 
                            üìä ${dados.amostras.length} amostras</small>
                        </div>
                        <div class="canteiro-actions">
                            <button class="btn btn-small btn-primary" onclick="abrirCanteiro('${canteiro}')">Abrir</button>
                            <button class="btn btn-small btn-danger" onclick="confirmarExclusao('${canteiro}')">Excluir</button>
                        </div>
                    `;
                    container.appendChild(item);
                }
            }
            
            document.getElementById('saved-canteiros-list').style.display = canteirosEncontrados ? 'block' : 'none';
        }

        // ===== NAVEGA√á√ÉO =====
        function mostrarCanteirosSalvos() {
            carregarCanteirosSalvos();
        }

        function novoCanteiro() {
            // Limpar dados
            amostras = [];
            configuracao = {};
            canteiroAtual = null;
            
            // Limpar campos
            document.getElementById('canteiro-num').value = '';
            document.getElementById('data-plantio').valueAsDate = new Date();
            document.getElementById('tipo-teste').value = '';
            
            // Resetar lado
            document.querySelectorAll('.lado-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-lado="direito"]').classList.add('active');
            ladoAtual = 'direito';
            
            // Mostrar painel
            mostrarPainel('setup-panel');
        }

        function abrirCanteiro(canteiro) {
            if (carregarDados(canteiro)) {
                gerarMapa();
                mostrarPainel('map-panel');
            } else {
                alert('Erro ao carregar canteiro!');
            }
        }

        function voltarMenu() {
            mostrarPainel('main-menu');
        }

        function voltarParaSetup() {
            mostrarPainel('setup-panel');
        }

        function mostrarPainel(panelId) {
            // Esconder todos os pain√©is
            document.querySelectorAll('.main-menu, .setup-panel, .scanning-panel, .manual-entry-panel, .map-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Mostrar painel espec√≠fico
            document.getElementById(panelId).style.display = 'block';
        }

        // ===== LEITURA QR =====
        async function iniciarScan() {
            if (!validarConfiguracao()) return;
            
            mostrarPainel('scanning-panel');
            
            try {
                const video = document.getElementById('qr-video');
                scanner = new QrScanner(video, result => processarQRCode(result), {
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                });
                await scanner.start();
                document.getElementById('scan-status').textContent = 'C√¢mera ativa - Posicione o QR code';
                atualizarContadorAmostras();
            } catch (error) {
                console.error('Erro ao inicializar scanner:', error);
                alert('Erro ao acessar c√¢mera. Verifique as permiss√µes.');
            }
        }

        function processarQRCode(result) {
            try {
                const url = result.data;
                const match = url.match(/codigoamostra=(\d+)/);
                if (!match) {
                    alert('QR code inv√°lido! Formato esperado n√£o encontrado.');
                    return;
                }

                const codigoAmostra = match[1];
                
                if (amostras.some(a => a.codigo === codigoAmostra)) {
                    alert(`Amostra ${codigoAmostra} j√° foi lida!`);
                    return;
                }

                const amostra = {
                    codigo: codigoAmostra,
                    url: url,
                    lado: ladoAtual,
                    posicao: amostras.filter(a => a.lado === ladoAtual).length + 1,
                    timestamp: new Date().toISOString()
                };

                amostras.push(amostra);
                salvarDados();
                atualizarContadorAmostras();
                
                navigator.vibrate && navigator.vibrate(100);
                
            } catch (error) {
                console.error('Erro ao processar QR:', error);
                alert('Erro ao processar QR code');
            }
        }

        function trocarLado() {
            ladoAtual = ladoAtual === 'direito' ? 'esquerdo' : 'direito';
            document.getElementById('current-side').textContent = ladoAtual === 'direito' ? 'Direito' : 'Esquerdo';
        }

        function finalizarScan() {
            if (amostras.length === 0) {
                alert('Nenhuma amostra foi lida ainda!');
                return;
            }
            pararScan();
            gerarMapa();
        }

        function pararScan() {
            if (scanner) {
                scanner.stop();
                scanner = null;
            }
            mostrarPainel('setup-panel');
        }

        function continuarAdicionando() {
            mostrarPainel('setup-panel');
        }

        // ===== ENTRADA MANUAL =====
        function mostrarEntradaManual() {
            if (!validarConfiguracao()) return;
            
            // Definir pr√≥xima posi√ß√£o sugerida
            const proximaPosicao = amostras.filter(a => a.lado === ladoAtual).length + 1;
            document.getElementById('manual-posicao').value = proximaPosicao;
            document.getElementById('manual-lado').value = ladoAtual;
            document.getElementById('manual-codigo').value = '';
            document.getElementById('manual-tipo-teste-individual').value = configuracao.tipoTeste; // Sugerir o tipo do canteiro
            document.getElementById('manual-tipo-remessa').value = '';
            document.getElementById('preview-area').style.display = 'none';
            
            mostrarPainel('manual-entry-panel');
        }

        function adicionarAmostraManual() {
            const codigosInput = document.getElementById('manual-codigo').value.trim();
            const tipoTesteIndividual = document.getElementById('manual-tipo-teste-individual').value;
            const tipoRemessa = document.getElementById('manual-tipo-remessa').value;
            const lado = document.getElementById('manual-lado').value;
            const posicaoInicial = parseInt(document.getElementById('manual-posicao').value);

            if (!codigosInput) {
                alert('Por favor, insira o(s) c√≥digo(s) da(s) amostra(s)!');
                return;
            }

            if (!tipoTesteIndividual) {
                alert('Por favor, selecione o tipo de teste!');
                return;
            }

            if (!tipoRemessa) {
                alert('Por favor, selecione a origem da amostra!');
                return;
            }

            if (!posicaoInicial || posicaoInicial < 1) {
                alert('Por favor, insira uma posi√ß√£o inicial v√°lida!');
                return;
            }

            // Processar c√≥digos (separados por ; ou √∫nico)
            const codigos = codigosInput.split(';').map(c => c.trim()).filter(c => c.length > 0);
            
            if (codigos.length === 0) {
                alert('Nenhum c√≥digo v√°lido encontrado!');
                return;
            }

            // Verificar c√≥digos duplicados no input
            const codigosUnicos = [...new Set(codigos)];
            if (codigosUnicos.length !== codigos.length) {
                alert('‚ùå C√≥digos duplicados no input!\n\nRemova as duplicatas e tente novamente.');
                return;
            }

            // Verificar se algum c√≥digo j√° existe no sistema COM O MESMO TIPO DE TESTE
            const codigosExistentes = codigos.filter(codigo => 
                amostras.some(a => a.codigo === codigo && a.tipoTeste === tipoTesteIndividual)
            );
            
            if (codigosExistentes.length > 0) {
                alert(`‚ùå C√≥digos j√° existem no sistema para o teste ${tipoTesteIndividual}:\n${codigosExistentes.join(', ')}\n\nüí° Observa√ß√£o: O mesmo c√≥digo pode existir para testes diferentes (GA, EA48, EA72)`);
                return;
            }

            // Verificar conflitos de posi√ß√£o
            const conflitos = [];
            for (let i = 0; i < codigos.length; i++) {
                const posicao = posicaoInicial + i;
                const conflito = amostras.find(a => a.lado === lado && a.posicao === posicao);
                if (conflito) {
                    conflitos.push(`Posi√ß√£o ${posicao}: ${conflito.codigo} (${conflito.tipoTeste || 'N/A'})`);
                }
            }

            if (conflitos.length > 0) {
                const confirmar = confirm(`‚ö†Ô∏è CONFLITOS DE POSI√á√ÉO:\n\n${conflitos.join('\n')}\n\nDeseja substituir essas amostras?`);
                if (!confirmar) {
                    return;
                }
                
                // Remover amostras conflitantes
                for (let i = 0; i < codigos.length; i++) {
                    const posicao = posicaoInicial + i;
                    amostras = amostras.filter(a => !(a.lado === lado && a.posicao === posicao));
                }
            }

            // Adicionar todas as amostras
            const amostrasAdicionadas = [];
            for (let i = 0; i < codigos.length; i++) {
                const codigo = codigos[i];
                const posicao = posicaoInicial + i;
                
                const amostra = {
                    codigo: codigo,
                    url: `http://softsulsistemas.com.br/?codigoamostra=${codigo}`,
                    lado: lado,
                    posicao: posicao,
                    tipoRemessa: tipoRemessa,
                    tipoTeste: tipoTesteIndividual, // Usar tipo de teste individual
                    timestamp: new Date().toISOString(),
                    manual: true
                };
                
                amostras.push(amostra);
                amostrasAdicionadas.push(`${codigo} (${tipoTesteIndividual}) ‚Üí Pos. ${posicao}`);
            }

            salvarDados();
            
            // Mostrar resumo
            const resumo = `‚úÖ ${codigos.length} amostra(s) adicionada(s)!\n\nTeste: ${tipoTesteIndividual}\nOrigem: ${tipoRemessa}\nLado: ${lado}\n\nDetalhes:\n${amostrasAdicionadas.join('\n')}`;
            alert(resumo);
            
            // Limpar formul√°rio e sugerir pr√≥xima posi√ß√£o
            document.getElementById('manual-codigo').value = '';
            document.getElementById('manual-tipo-teste-individual').value = '';
            document.getElementById('manual-tipo-remessa').value = '';
            document.getElementById('preview-area').style.display = 'none';
            
            const proximaPosicao = Math.max(...amostras.filter(a => a.lado === lado).map(a => a.posicao)) + 1;
            document.getElementById('manual-posicao').value = proximaPosicao;
        }

        function previewAmostras() {
            const codigosInput = document.getElementById('manual-codigo').value.trim();
            const tipoTesteIndividual = document.getElementById('manual-tipo-teste-individual').value;
            const tipoRemessa = document.getElementById('manual-tipo-remessa').value;
            const lado = document.getElementById('manual-lado').value;
            const posicaoInicial = parseInt(document.getElementById('manual-posicao').value);

            if (!codigosInput) {
                alert('Digite os c√≥digos das amostras para ver o preview!');
                return;
            }

            if (!posicaoInicial || posicaoInicial < 1) {
                alert('Digite uma posi√ß√£o inicial v√°lida!');
                return;
            }

            // Processar c√≥digos
            const codigos = codigosInput.split(';').map(c => c.trim()).filter(c => c.length > 0);
            
            if (codigos.length === 0) {
                alert('Nenhum c√≥digo v√°lido encontrado!');
                return;
            }

            // Gerar preview
            const tipoTestePrev = tipoTesteIndividual || 'N√£o selecionado';
            let previewHtml = `<strong>üìä Ser√°(√£o) criada(s) ${codigos.length} amostra(s) para ${tipoTestePrev}:</strong><br><br>`;
            
            for (let i = 0; i < codigos.length; i++) {
                const codigo = codigos[i];
                const posicao = posicaoInicial + i;
                const existeNoTeste = tipoTesteIndividual ? amostras.some(a => a.codigo === codigo && a.tipoTeste === tipoTesteIndividual) : false;
                const existeOutroTeste = tipoTesteIndividual ? amostras.some(a => a.codigo === codigo && a.tipoTeste !== tipoTesteIndividual) : false;
                const conflito = amostras.find(a => a.lado === lado && a.posicao === posicao);
                
                let status = '‚úÖ';
                let observacao = '';
                
                if (existeNoTeste && tipoTesteIndividual) {
                    status = '‚ùå';
                    observacao = ` (J√Å EXISTE PARA ${tipoTesteIndividual})`;
                } else if (existeOutroTeste && tipoTesteIndividual) {
                    const outroTeste = amostras.find(a => a.codigo === codigo && a.tipoTeste !== tipoTesteIndividual);
                    observacao = ` (j√° existe para ${outroTeste.tipoTeste})`;
                }
                
                if (conflito) {
                    if (status === '‚úÖ') status = '‚ö†Ô∏è';
                    observacao += ` | substituir√° ${conflito.codigo} (${conflito.tipoTeste || 'N/A'})`;
                }
                
                previewHtml += `${status} <strong>${codigo}</strong> (${tipoTestePrev}) ‚Üí Posi√ß√£o ${posicao} (${lado})${observacao}<br>`;
            }
            
            if (tipoRemessa) {
                previewHtml += `<br><strong>Origem:</strong> ${tipoRemessa}`;
            }

            document.getElementById('preview-content').innerHTML = previewHtml;
            document.getElementById('preview-area').style.display = 'block';
        }

        // ===== GERENCIAMENTO DO MAPA =====
        function gerarMapa() {
            mostrarPainel('map-panel');
            
            document.getElementById('canteiro-title').textContent = `Mapa do Canteiro ${configuracao.canteiro}`;
            document.getElementById('canteiro-details').innerHTML = `
                üìÖ Data: ${new Date(configuracao.data).toLocaleDateString('pt-BR')} | 
                üß™ Teste: ${configuracao.tipoTeste} | 
                üìä Total de Amostras: ${amostras.length}
            `;

            const amostrasEsquerda = amostras.filter(a => a.lado === 'esquerdo').sort((a, b) => a.posicao - b.posicao);
            const amostrasDireita = amostras.filter(a => a.lado === 'direito').sort((a, b) => a.posicao - b.posicao);
            
            const maxPosicoes = Math.max(amostrasEsquerda.length, amostrasDireita.length, 45); // 45 posi√ß√µes por lado = 90 total

            const tbody = document.getElementById('mapa-tbody');
            tbody.innerHTML = '';

            for (let i = 0; i < maxPosicoes; i++) {
                const row = document.createElement('tr');
                
                // Posi√ß√£o
                const posicaoCell = document.createElement('td');
                posicaoCell.textContent = i + 1;
                posicaoCell.style.fontWeight = 'bold';
                row.appendChild(posicaoCell);

                // Lado Esquerdo
                const esquerdaCell = document.createElement('td');
                esquerdaCell.className = 'sample-cell';
                const amostraEsquerda = amostrasEsquerda.find(a => a.posicao === i + 1);
                if (amostraEsquerda) {
                    esquerdaCell.innerHTML = `
                        <strong>${amostraEsquerda.codigo}</strong>
                        <div class="sample-info">${amostraEsquerda.tipoTeste || 'N/A'}${amostraEsquerda.tipoRemessa ? ' | ' + amostraEsquerda.tipoRemessa : ''} | ${new Date(amostraEsquerda.timestamp).toLocaleDateString('pt-BR')}${amostraEsquerda.manual ? ' (Manual)' : ''}</div>
                    `;
                    esquerdaCell.style.cursor = 'pointer';
                    // Usar closure para capturar a amostra correta
                    (function(amostra) {
                        esquerdaCell.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Clique na amostra:', JSON.stringify(amostra, null, 2));
                            editarOuRemoverAmostra(amostra);
                        });
                    })(amostraEsquerda);
                } else {
                    esquerdaCell.innerHTML = '<em style="color: #ccc;">Vazio</em>';
                    esquerdaCell.className += ' empty';
                    esquerdaCell.style.cursor = 'pointer';
                    // Usar closure para capturar os valores corretos
                    (function(lado, posicao) {
                        esquerdaCell.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Clique em posi√ß√£o vazia:', lado, posicao);
                            adicionarAmostraNaPosicao(lado, posicao);
                        });
                    })('esquerdo', i + 1);
                }
                row.appendChild(esquerdaCell);

                // Lado Direito
                const direitaCell = document.createElement('td');
                direitaCell.className = 'sample-cell';
                const amostraDireita = amostrasDireita.find(a => a.posicao === i + 1);
                if (amostraDireita) {
                    direitaCell.innerHTML = `
                        <strong>${amostraDireita.codigo}</strong>
                        <div class="sample-info">${amostraDireita.tipoTeste || 'N/A'}${amostraDireita.tipoRemessa ? ' | ' + amostraDireita.tipoRemessa : ''} | ${new Date(amostraDireita.timestamp).toLocaleDateString('pt-BR')}${amostraDireita.manual ? ' (Manual)' : ''}</div>
                    `;
                    direitaCell.style.cursor = 'pointer';
                    // Usar closure para capturar a amostra correta
                    (function(amostra) {
                        direitaCell.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Clique na amostra:', JSON.stringify(amostra, null, 2));
                            editarOuRemoverAmostra(amostra);
                        });
                    })(amostraDireita);
                } else {
                    direitaCell.innerHTML = '<em style="color: #ccc;">Vazio</em>';
                    direitaCell.className += ' empty';
                    direitaCell.style.cursor = 'pointer';
                    // Usar closure para capturar os valores corretos
                    (function(lado, posicao) {
                        direitaCell.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Clique em posi√ß√£o vazia:', lado, posicao);
                            adicionarAmostraNaPosicao(lado, posicao);
                        });
                    })('direito', i + 1);
                }
                row.appendChild(direitaCell);

                tbody.appendChild(row);
            }
        }

        function editarOuRemoverAmostra(amostra) {
            console.log('Fun√ß√£o editarOuRemoverAmostra - objeto recebido:', JSON.stringify(amostra, null, 2));
            
            // Verifica√ß√£o mais detalhada
            if (!amostra) {
                alert('Erro: Amostra √© null ou undefined!');
                return;
            }
            
            if (typeof amostra !== 'object') {
                alert('Erro: Amostra n√£o √© um objeto v√°lido!');
                return;
            }
            
            if (!amostra.codigo) {
                alert('Erro: C√≥digo da amostra n√£o encontrado!\n\nDados recebidos: ' + JSON.stringify(amostra));
                return;
            }

            // Criar mensagem com informa√ß√µes da amostra
            const dataFormatada = new Date(amostra.timestamp).toLocaleDateString('pt-BR');
            const info = `AMOSTRA: ${amostra.codigo}
POSI√á√ÉO: ${amostra.posicao} (${amostra.lado})
ORIGEM: ${amostra.tipoRemessa || 'N√£o definido'}
DATA: ${dataFormatada}

O que deseja fazer?`;
            
            // Tentar com alert primeiro para debug
            console.log('Tentando mostrar op√ß√µes para amostra:', amostra.codigo);
            
            // Op√ß√£o 1: Editar posi√ß√£o
            const opcao1 = confirm(`${info}

üî∑ OP√á√ÉO 1: EDITAR POSI√á√ÉO
Clique OK para editar a posi√ß√£o
Clique CANCELAR para ver pr√≥xima op√ß√£o`);
            
            if (opcao1) {
                console.log('Usu√°rio escolheu: Editar posi√ß√£o');
                editarPosicaoAmostra(amostra);
                return;
            }
            
            // Op√ß√£o 2: Limpar posi√ß√£o
            const opcao2 = confirm(`${info}

üî∑ OP√á√ÉO 2: LIMPAR POSI√á√ÉO
Clique OK para limpar esta posi√ß√£o
Clique CANCELAR para ver pr√≥xima op√ß√£o`);
            
            if (opcao2) {
                console.log('Usu√°rio escolheu: Limpar posi√ß√£o');
                limparPosicaoAmostra(amostra);
                return;
            }
            
            // Op√ß√£o 3: Remover amostra
            const opcao3 = confirm(`${info}

üî∑ OP√á√ÉO 3: REMOVER AMOSTRA
Clique OK para remover completamente
Clique CANCELAR para sair`);
            
            if (opcao3) {
                console.log('Usu√°rio escolheu: Remover amostra');
                removerAmostra(amostra);
                return;
            }
            
            console.log('Usu√°rio cancelou todas as op√ß√µes ou saiu');
        }

        function editarPosicaoAmostra(amostra) {
            console.log('Editando posi√ß√£o da amostra:', amostra.codigo);
            
            const novaPosicao = prompt(`‚úèÔ∏è EDITAR POSI√á√ÉO

Amostra: ${amostra.codigo}
Posi√ß√£o atual: ${amostra.posicao} (${amostra.lado})
Origem: ${amostra.tipoRemessa || 'N√£o definido'}

‚û°Ô∏è Digite a nova posi√ß√£o:`, amostra.posicao);
            
            if (!novaPosicao) {
                console.log('Usu√°rio cancelou a edi√ß√£o de posi√ß√£o');
                return;
            }
            
            const posicaoNum = parseInt(novaPosicao);
            
            if (isNaN(posicaoNum) || posicaoNum < 1) {
                alert('‚ùå Posi√ß√£o inv√°lida!\n\nDigite um n√∫mero maior que 0.');
                return;
            }
            
            // Verificar se posi√ß√£o j√° est√° ocupada
            const ocupada = amostras.find(a => a.lado === amostra.lado && a.posicao === posicaoNum && a.codigo !== amostra.codigo);
            if (ocupada) {
                alert(`‚ùå Posi√ß√£o ${posicaoNum} j√° ocupada!\n\nAmostra: ${ocupada.codigo}`);
                return;
            }
            
            // Encontrar e atualizar a amostra
            const index = amostras.findIndex(a => a.codigo === amostra.codigo);
            console.log('√çndice da amostra encontrado:', index);
            
            if (index !== -1) {
                console.log('Atualizando posi√ß√£o de', amostras[index].posicao, 'para', posicaoNum);
                amostras[index].posicao = posicaoNum;
                salvarDados();
                gerarMapa();
                alert(`‚úÖ Sucesso!\n\nAmostra ${amostra.codigo} movida para posi√ß√£o ${posicaoNum}`);
            } else {
                console.error('Amostra n√£o encontrada no array:', amostra);
                alert('‚ùå Erro: Amostra n√£o encontrada no sistema!');
            }
        }

        function limparPosicaoAmostra(amostra) {
            const confirmacao = confirm(`üßπ LIMPAR POSI√á√ÉO\n\nAmostra: ${amostra.codigo}\nPosi√ß√£o: ${amostra.posicao} (${amostra.lado})\n\n‚ö†Ô∏è Esta a√ß√£o remover√° a amostra desta posi√ß√£o.\n\nDeseja continuar?`);
            
            if (confirmacao) {
                amostras = amostras.filter(a => a.codigo !== amostra.codigo);
                salvarDados();
                gerarMapa();
                alert(`‚úÖ Posi√ß√£o limpa!\n\nPosi√ß√£o ${amostra.posicao} (${amostra.lado}) est√° agora dispon√≠vel.`);
            } else {
                console.log('Usu√°rio cancelou a limpeza da posi√ß√£o');
            }
        }

        function removerAmostra(amostra) {
            const confirmacao = confirm(`üóëÔ∏è REMOVER AMOSTRA\n\nAmostra: ${amostra.codigo}\nPosi√ß√£o: ${amostra.posicao} (${amostra.lado})\n\n‚ö†Ô∏è Esta a√ß√£o remover√° a amostra completamente do canteiro.\n\nDeseja continuar?`);
            
            if (confirmacao) {
                amostras = amostras.filter(a => a.codigo !== amostra.codigo);
                salvarDados();
                gerarMapa();
                alert(`‚úÖ Amostra removida!\n\nAmostra ${amostra.codigo} foi removida do canteiro.`);
            } else {
                console.log('Usu√°rio cancelou a remo√ß√£o da amostra');
            }
        }

        function adicionarAmostraNaPosicao(lado, posicao) {
            console.log('Adicionando amostra na posi√ß√£o:', lado, posicao);
            
            const codigo = prompt(`Adicionar amostra na posi√ß√£o ${posicao} (${lado}):\n\nC√≥digo da amostra:`);
            if (codigo && codigo.trim()) {
                const codigoLimpo = codigo.trim();
                
                // Pedir tipo de teste
                const tipoTeste = prompt(`Tipo de teste para amostra ${codigoLimpo}:\n\n1 - GA\n2 - EA48\n3 - EA72\n\nDigite o n√∫mero da op√ß√£o:`);
                
                let tipoTesteTexto = '';
                switch(tipoTeste) {
                    case '1': tipoTesteTexto = 'GA'; break;
                    case '2': tipoTesteTexto = 'EA48'; break;
                    case '3': tipoTesteTexto = 'EA72'; break;
                    default:
                        alert('Tipo de teste n√£o selecionado. Usando o padr√£o do canteiro.');
                        tipoTesteTexto = configuracao.tipoTeste;
                        break;
                }
                
                // Verificar se c√≥digo j√° existe PARA O MESMO TIPO DE TESTE
                if (amostras.some(a => a.codigo === codigoLimpo && a.tipoTeste === tipoTesteTexto)) {
                    alert(`Amostra ${codigoLimpo} j√° foi adicionada para o teste ${tipoTesteTexto}!`);
                    return;
                }
                
                // Pedir origem da amostra
                const tipoRemessa = prompt(`Origem da amostra ${codigoLimpo}:\n\n1 - Lote\n2 - TSI\n3 - Carregamento\n4 - Teste\n5 - Reclama√ß√£o\n6 - Entrada de Semente\n\nDigite o n√∫mero da op√ß√£o:`);
                
                let tipoRemessaTexto = '';
                switch(tipoRemessa) {
                    case '1': tipoRemessaTexto = 'Lote'; break;
                    case '2': tipoRemessaTexto = 'TSI'; break;
                    case '3': tipoRemessaTexto = 'Carregamento'; break;
                    case '4': tipoRemessaTexto = 'Teste'; break;
                    case '5': tipoRemessaTexto = 'Reclama√ß√£o'; break;
                    case '6': tipoRemessaTexto = 'Entrada de Semente'; break;
                    default:
                        alert('Origem n√£o selecionada. Usando "Teste" como padr√£o.');
                        tipoRemessaTexto = 'Teste';
                        break;
                }
                
                const amostra = {
                    codigo: codigoLimpo,
                    url: `http://softsulsistemas.com.br/?codigoamostra=${codigoLimpo}`,
                    lado: lado,
                    posicao: posicao,
                    tipoRemessa: tipoRemessaTexto,
                    tipoTeste: tipoTesteTexto, // Usar tipo de teste individual
                    timestamp: new Date().toISOString(),
                    manual: true
                };
                
                amostras.push(amostra);
                salvarDados();
                gerarMapa();
                alert(`‚úÖ Amostra adicionada!\n\nC√≥digo: ${codigoLimpo}\nTeste: ${tipoTesteTexto}\nOrigem: ${tipoRemessaTexto}\nPosi√ß√£o: ${posicao} (${lado})`);
            }
        }

        function limparCanteiro() {
            mostrarModal(
                'Limpar Canteiro',
                `Deseja realmente limpar todas as amostras do canteiro ${configuracao.canteiro}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`,
                () => {
                    amostras = [];
                    salvarDados();
                    gerarMapa();
                    alert('Canteiro limpo com sucesso!');
                    fecharModal();
                }
            );
        }

        // ===== UTILIT√ÅRIOS =====
        function validarConfiguracao() {
            const canteiroNum = document.getElementById('canteiro-num').value;
            const dataPlantio = document.getElementById('data-plantio').value;
            const tipoTeste = document.getElementById('tipo-teste').value;

            if (!canteiroNum || !dataPlantio || !tipoTeste) {
                alert('Por favor, preencha todos os campos obrigat√≥rios!');
                return false;
            }

            configuracao = {
                canteiro: canteiroNum,
                data: dataPlantio,
                tipoTeste: tipoTeste,
                ladoInicial: ladoAtual
            };

            return true;
        }

        function atualizarContadorAmostras() {
            document.getElementById('sample-count').textContent = amostras.length;
            document.getElementById('current-side').textContent = ladoAtual === 'direito' ? 'Direito' : 'Esquerdo';
        }

        function confirmarExclusao(canteiro) {
            mostrarModal(
                'Excluir Canteiro',
                `Deseja realmente excluir o canteiro ${canteiro}?\n\nTodos os dados ser√£o perdidos!`,
                () => {
                    localStorage.removeItem(`canteiro_${canteiro}`);
                    carregarCanteirosSalvos();
                    alert('Canteiro exclu√≠do com sucesso!');
                    fecharModal();
                }
            );
        }

        // ===== MODAL =====
        function mostrarModal(titulo, mensagem, callbackConfirmar) {
            document.getElementById('modal-title').textContent = titulo;
            document.getElementById('modal-message').textContent = mensagem;
            document.getElementById('modal-confirm').onclick = callbackConfirmar;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // ===== IMPORTA√á√ÉO/EXPORTA√á√ÉO =====
        function exportarMapa() {
            const dados = {
                configuracao: configuracao,
                amostras: amostras,
                dataExportacao: new Date().toISOString(),
                versao: '2.0'
            };

            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mapa_Canteiro_${configuracao.canteiro}_${configuracao.data.replace(/-/g, '')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('Mapa exportado em JSON com sucesso!');
        }

        async function exportarPDF() {
            try {
                // Verificar se as bibliotecas est√£o carregadas
                if (typeof window.jspdf === 'undefined') {
                    alert('Biblioteca PDF n√£o carregada. Tente recarregar a p√°gina.');
                    return;
                }

                // Mostrar mensagem de carregamento
                const btnPDF = event.target;
                const textoOriginal = btnPDF.textContent;
                btnPDF.textContent = '‚è≥ Gerando PDF...';
                btnPDF.disabled = true;

                // Aguardar um pouco para a interface atualizar
                await new Promise(resolve => setTimeout(resolve, 100));

                // Criar vers√£o simplificada para PDF
                const dadosPDF = criarDadosPDF();
                
                // Criar PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Configura√ß√µes
                const margem = 20;
                const larguraPagina = 210 - (margem * 2); // A4 width - margens
                let yPosition = margem;

                // T√≠tulo
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`Mapa do Canteiro ${configuracao.canteiro}`, margem, yPosition);
                yPosition += 15;

                // Informa√ß√µes
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Data: ${new Date(configuracao.data).toLocaleDateString('pt-BR')}`, margem, yPosition);
                pdf.text(`Teste: ${configuracao.tipoTeste}`, margem + 60, yPosition);
                pdf.text(`Amostras: ${amostras.length}`, margem + 120, yPosition);
                yPosition += 10;

                pdf.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, margem, yPosition);
                yPosition += 20;

                // Tabela
                const colunaLargura = larguraPagina / 3;
                const linhaAltura = 10;

                // Cabe√ßalho da tabela
                pdf.setFillColor(240, 240, 240);
                pdf.rect(margem, yPosition, colunaLargura, linhaAltura, 'F');
                pdf.rect(margem + colunaLargura, yPosition, colunaLargura, linhaAltura, 'F');
                pdf.rect(margem + (colunaLargura * 2), yPosition, colunaLargura, linhaAltura, 'F');

                pdf.setFont('helvetica', 'bold');
                pdf.text('Posi√ß√£o', margem + 5, yPosition + 7);
                pdf.text('Lado Esquerdo', margem + colunaLargura + 5, yPosition + 7);
                pdf.text('Lado Direito', margem + (colunaLargura * 2) + 5, yPosition + 7);
                yPosition += linhaAltura;

                // Dados da tabela
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);

                const amostrasEsquerda = amostras.filter(a => a.lado === 'esquerdo').sort((a, b) => a.posicao - b.posicao);
                const amostrasDireita = amostras.filter(a => a.lado === 'direito').sort((a, b) => a.posicao - b.posicao);
                const maxPosicoes = Math.max(amostrasEsquerda.length, amostrasDireita.length, 45);

                for (let i = 0; i < maxPosicoes; i++) {
                    // Verificar se precisa de nova p√°gina
                    if (yPosition > 250) {
                        pdf.addPage();
                        yPosition = margem;
                        
                        // Repetir cabe√ßalho na nova p√°gina
                        pdf.setFillColor(240, 240, 240);
                        pdf.rect(margem, yPosition, colunaLargura, linhaAltura, 'F');
                        pdf.rect(margem + colunaLargura, yPosition, colunaLargura, linhaAltura, 'F');
                        pdf.rect(margem + (colunaLargura * 2), yPosition, colunaLargura, linhaAltura, 'F');

                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(10);
                        pdf.text('Posi√ß√£o', margem + 5, yPosition + 7);
                        pdf.text('Lado Esquerdo', margem + colunaLargura + 5, yPosition + 7);
                        pdf.text('Lado Direito', margem + (colunaLargura * 2) + 5, yPosition + 7);
                        yPosition += linhaAltura;
                        
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(9);
                    }

                    const posicao = i + 1;
                    const amostraEsq = amostrasEsquerda.find(a => a.posicao === posicao);
                    const amostraDir = amostrasDireita.find(a => a.posicao === posicao);

                    // Bordas das c√©lulas
                    pdf.rect(margem, yPosition, colunaLargura, linhaAltura * 2); // Altura dupla para mais informa√ß√µes
                    pdf.rect(margem + colunaLargura, yPosition, colunaLargura, linhaAltura * 2);
                    pdf.rect(margem + (colunaLargura * 2), yPosition, colunaLargura, linhaAltura * 2);

                    // Posi√ß√£o
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(posicao.toString(), margem + 5, yPosition + 6);
                    pdf.setFont('helvetica', 'normal');
                    
                    // Lado Esquerdo
                    if (amostraEsq) {
                        const dataFormatada = new Date(amostraEsq.timestamp).toLocaleDateString('pt-BR');
                        const tipoTeste = amostraEsq.tipoTeste || configuracao.tipoTeste;
                        const origem = amostraEsq.tipoRemessa || 'N/A';
                        const manual = amostraEsq.manual ? ' (Manual)' : '';
                        
                        // C√≥digo em negrito
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(amostraEsq.codigo, margem + colunaLargura + 5, yPosition + 6);
                        
                        // Informa√ß√µes detalhadas
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(7);
                        const infoTexto = `${tipoTeste} | ${origem} | ${dataFormatada}${manual}`;
                        pdf.text(infoTexto, margem + colunaLargura + 5, yPosition + 12);
                        pdf.setFontSize(9);
                    } else {
                        pdf.setTextColor(128, 128, 128);
                        pdf.text('Vazio', margem + colunaLargura + 5, yPosition + 10);
                        pdf.setTextColor(0, 0, 0);
                    }

                    // Lado Direito
                    if (amostraDir) {
                        const dataFormatada = new Date(amostraDir.timestamp).toLocaleDateString('pt-BR');
                        const tipoTeste = amostraDir.tipoTeste || configuracao.tipoTeste;
                        const origem = amostraDir.tipoRemessa || 'N/A';
                        const manual = amostraDir.manual ? ' (Manual)' : '';
                        
                        // C√≥digo em negrito
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(amostraDir.codigo, margem + (colunaLargura * 2) + 5, yPosition + 6);
                        
                        // Informa√ß√µes detalhadas
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(7);
                        const infoTexto = `${tipoTeste} | ${origem} | ${dataFormatada}${manual}`;
                        pdf.text(infoTexto, margem + (colunaLargura * 2) + 5, yPosition + 12);
                        pdf.setFontSize(9);
                    } else {
                        pdf.setTextColor(128, 128, 128);
                        pdf.text('Vazio', margem + (colunaLargura * 2) + 5, yPosition + 10);
                        pdf.setTextColor(0, 0, 0);
                    }

                    yPosition += linhaAltura * 2; // Altura dupla
                }

                // Salvar PDF
                const nomeArquivo = `Mapa_Canteiro_${configuracao.canteiro}_${configuracao.data.replace(/-/g, '')}.pdf`;
                pdf.save(nomeArquivo);

                // Restaurar bot√£o
                btnPDF.textContent = textoOriginal;
                btnPDF.disabled = false;
                
                alert('PDF gerado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                
                // Restaurar bot√£o em caso de erro
                if (event && event.target) {
                    event.target.textContent = 'üìë Exportar PDF';
                    event.target.disabled = false;
                }
                
                alert('Erro ao gerar PDF: ' + error.message);
            }
        }

        function criarDadosPDF() {
            return {
                configuracao: configuracao,
                amostras: amostras,
                dataGeracao: new Date().toISOString()
            };
        }

        function importarDados() {
            document.getElementById('import-input').click();
        }

        function processarImportacao(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (!dados.configuracao || !dados.amostras) {
                        alert('Arquivo inv√°lido! Formato n√£o reconhecido.');
                        return;
                    }

                    // Verificar se canteiro j√° existe
                    const canteiroExiste = localStorage.getItem(`canteiro_${dados.configuracao.canteiro}`);
                    if (canteiroExiste) {
                        if (!confirm(`Canteiro ${dados.configuracao.canteiro} j√° existe. Deseja sobrescrever?`)) {
                            return;
                        }
                    }

                    // Importar dados
                    configuracao = dados.configuracao;
                    amostras = dados.amostras;
                    
                    salvarDados();
                    carregarCanteirosSalvos();
                    
                    alert(`Canteiro ${configuracao.canteiro} importado com sucesso!\n${amostras.length} amostras carregadas.`);
                    
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    alert('Erro ao processar arquivo. Verifique se √© um arquivo v√°lido.');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Limpar input
        }

        // ===== EVENTOS GLOBAIS =====
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                fecharModal();
            }
        }
    </script>
</body>
</html>
